# dutClasstable
曾经的那个为大家提供各种教务服务的大连理工大学微信小程序，于2019年9月末下线，不知道未来有没有机会回来。这个小程序不是我个人首创，我只是作为延续者和传承者，对这个小程序进行了第三代改进。首版与二版均来自于大工2014级一位学长，也就是我入学时当时的部长。
前端:wxml&wxss&js
后端：php和极少的js，

本科要毕业了，代码就先不上传了，别对学校造成任何不良影响，有需要交流的可以联系我，不出意外的话2024年6月之前，我应该一直在大工。
e-mail：zhangchunli711@gmail.com
   或zhangchunli711@foxmail.com

## 工作原理
   前端就是简单的微信小程序，不过由于小程序最初上线比较早，后面虽然更新了几代，但是写法还是比较旧。
   后端架构稍微麻烦，因为曾经学校教务系统必须学校内网才能直接访问，所以后端使用了两台服务器。一台为阿里云云服务器，另一台为学校内网自搭建服务，使用内网穿透工具（frp）链接两个服务器。内网服务器负责获取数据，公网服务器负责连接微信小程。
   第一代通过模拟登陆学校教务官网获取教务数据，第二代学校统一校园门户后通过模拟登陆校园门户利用校园门户cookie跳转教务官网，第三代学校摒弃旧版教务系统，推出新版教务综合系统后，采用模拟登陆校园门户之后使用cookie跳转新版教务综合系统，然后获取用户代码，请求数据接口截获对应数据包。因为刚刚开发完获取课表数据之后小程序即下线，所以只完成了抓取课表。笔者已经研究过抓取成绩，考试时间等数据完全类似。

## 整体结构
### 前端代码
   就是简简单单的微信小程序源码，没有太多花里胡哨的。不过其中数据处理格式和设置的一些缓存想要理解要花费一些时间，尤其是那个数据处理格式，第一代开发者的建立的结构真的玄学，但是却异常好用。找不到之前的图了，分析数据结构去看后端封装数据的代码吧。
   登录方式采用学号与统一身份认证密码的形式

### 后端公网云服务器
  主要负责接受内网服务器传来的获取到的各种数据，这些数据中基本上都还包含html标签，所以此时在云服务器上进行结构化数据获取并建立数据结构，然后返回给前端。

### 后端内网服务器
  负责模拟登录校园门户，这个要是自己探索你会发现非常的恶心，建议去官网去抓包看看就明白了了，不要以为构建好身份认证字符串就好了，还有6次重定向，要一直跟着跳，然后跳转新版教务综合管理系统，还有6次重定向，吐了。
  2021年初更新，新版教务综合系统又更新了，总体逻辑跟以往相似，但是请求的内容产生了改变。
  
  
# 注意 
其实在新版教务综合管理系统出来以后，学校教务资源均可以通过公网访问了，内网服务器不再需要，但是还没来得及转移我们就给下线了，所以后端代码可以放到一起了，节省点带宽资源，云服务器带宽挺贵的。

# 2022年更新，再次整理了一下整体逻辑，加上模拟登陆分析过程

### 登录请求表单内容：
在统一身份认证界面登录，对登录进行分析，获取到登录所需数据包，确定登陆所需参数
 ![image](https://user-images.githubusercontent.com/44056689/156692523-63793c4d-b696-45cf-ac09-e581192a69cd.png)

### 分析请求表单参数生成过程：
![image](https://user-images.githubusercontent.com/44056689/156692717-a8b95560-07bd-41db-ab58-8e32436b75bc.png)
参数生成并没有直接对账号密码进行处理，而是扔到了另外一个表单里面

分析源码脚本，看啊可能这些字段如何计算得到：login6.js
function login()里面 Line 529
![image](https://user-images.githubusercontent.com/44056689/156692834-f93ae62c-2931-4fac-b39a-663b1a25165d.png)

我们可以看到，ul，pl就是用户名和密码的长度，sl恒为0。最后提交的数据为实际计算的地方，而上面填写的内容，则没有提交，设置为了disabled。
	需要注意的是，rsa的生成，基于des加密生成的，调用的是strEnc(..args)，对账号密码字符串进行唯一性编码。其中lt需要在web页面上获取，其余的可以自行计算，strEnc函数来自脚本文件des.js，直接拿过来用就行了。

### 接下来登录：

![image](https://user-images.githubusercontent.com/44056689/156692914-1cf92195-32be-4bf8-9b10-650a8a98ec76.png)

拿到相应参数之后，直接按照相应参数进行登录请求，我们看到，其中有三次重定向（之前是六次）
	根据重定向的响应头location，跟着重定向去跳。注意每一次跳的时候都要保存cookie，用于下一次的跳转。一直到最后响应为200就可以了。将对应的cookie保存下来
![image](https://user-images.githubusercontent.com/44056689/156692958-ed316978-21ee-4b0a-b132-67343743c7a5.png)
![image](https://user-images.githubusercontent.com/44056689/156692967-171278a7-41ac-4e8c-a1ef-5578abc8dd3a.png)

登录至此完毕，已经获取到登陆的cookie，之后的每次操作都是，先登录，获取cookie，然后用cookie进行相关数据的获取。

### 然后就是对细节详细的获取，以玉兰卡余额为例：

![image](https://user-images.githubusercontent.com/44056689/156693038-e822d3ab-3979-4ed8-b632-aa67055e9c9f.png)

 ### 对于课程信息，现在可以这样获取，现在甚至有往年的课程：
 这里获取的课程信息可以直接在校园门户首页下方看到，课程信息相对来说已经足够完善
 ![image](https://user-images.githubusercontent.com/44056689/156693129-5ec220ee-61ef-4fff-aae6-0d620e217bdb.png)

![image](https://user-images.githubusercontent.com/44056689/156693137-4b17806f-4cd6-43e1-b3cb-a6d8db49d831.png)

 ### 由于旧版教务综合系统已经不用了，下面对新版教务综合系统进行分析。
![image](https://user-images.githubusercontent.com/44056689/156693201-13346107-509e-4c8c-90c5-eb727c045363.png)

#### 直接在校园门户去跳，也就是使用校园门户cookie去获取，三次重定向。

![image](https://user-images.githubusercontent.com/44056689/156693222-bde9f6d7-32b5-4df0-859b-01aaaa074d6d.png)

#### 通过统一身份认证去跳：
https://sso.dlut.edu.cn/cas/login?service=http%3A%2F%2Fjxgl.dlut.edu.cn%2Fstudent%2Fucas-sso%2Flogin

![image](https://user-images.githubusercontent.com/44056689/156693288-c0603c46-c5c5-4975-985e-5893d8141b77.png)

六次重定向，可以直接在sso界面登录到新版教务系统。Cookie长这样。
![image](https://user-images.githubusercontent.com/44056689/156693304-05697909-f702-42b4-9ad1-e72da82be185.png)

### 然后就是相关信息的获取（请求头请求体自行构建）：
http://jxgl.dlut.edu.cn/student/for-std/course-table/get-data?bizTypeId=2&semesterId=241
获取到一个数据包，里面就是当前学期的课程信息，通过更改semesterId是可以调整学期的

![image](https://user-images.githubusercontent.com/44056689/156693369-e5410777-6ec9-4d8b-b93e-dd1f4fffe4d1.png)

### 成绩信息：
http://jxgl.dlut.edu.cn/student/for-std/grade/sheet/info/673914?semester=
![image](https://user-images.githubusercontent.com/44056689/156693659-1804a135-acca-45f7-905b-ab773be7717d.png)

## ⭐难点与坑点总结，吐血之旅

（1）登陆的时候，神知道登陆表单在下面，知道登录参数之后，不知道在哪里产生的，实际的登陆表单被隐藏了，显示的不是实际使用的表单。
（2）cookie的使用
（3）多次重定向刚开始给搞懵了，乱七八糟，反复跟着一遍一遍地跳
（4）新版教务系统使用cookie还要多次重定向，摸不着头脑
（5）成绩数据最初是xml格式的，关键是不知道如何去解析，最后当作字符串人工解析到关键点然后用正则去拆分，现在只是分析了一下，并没实际写代码，实际情况以实操为准
（6）成绩和课表当时碰到的一个天坑就是，有同学有辅修，然后，获取信息的内容应该是两部分，直接就无法展示或者展示的不完整，当时因为测试的同学都没有辅修的情况，搞了好久。
（7） 数据拆分和对应数据获取，使用正则表达式去匹配来实现，刚开始不会正则，感觉都是乱七八糟，后来回了一点简单的就够用了
（8）数据结构的构建，也是一个挺大的问题，如何通过日期建立课表，如何将课表填入等。
![image](https://user-images.githubusercontent.com/44056689/156693839-e57ee1ed-850c-48a1-907f-e67f98814717.png)
